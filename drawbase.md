# 土台を描画する

## 楕円を描く関数を用意する
土台の楕円を描いていきましょう。と言いたいところなのですが、残念ながら用意されている関数では正円しか描くことができません。
正円を用いて楕円を描くには、正円を潰したり、伸ばしたりしてやるしかなさそうです。
このゲームでは楕円を多用するので、楕円を描く（正確にはパスを追加するところまで）関数`ellipse`を用意しましょう。

次の関数を`draw`関数の定義の前に書いてください。

```javascript
// cx, cy: 中心座標
// rx: X軸方向の半径, ry: Y軸方向の半径
function ellipse(cx, cy, rx, ry) {
    
}
```

`//`から行の終わりまではコメントという扱いになり、好きにメモを書いておくことができます。

`cx, cy, rx, ry`は呼び出し時の引数が保存される変数で、普通の変数と同じように扱うことができます。

中身が空ですね。1行ずつ説明しながら書き進めましょう。

まずはじめにすることは、座標軸を拡大縮小することです。
`ctx.scale(横の倍率, 縦の倍率)`で行うことができます。

![scaleの比較](images/scale.png)

<div class="advance">
<p>発展: この図を生成するやつは<a href="samples/scale.html">こちら</a></p>
</div>

この要領で横方向はそのまま、縦方向の倍率を変えてみることにしましょう。
縦方向を $$\frac{ry}{rx}$$ 倍すればよさそうですね。

```javascript
ctx.scale(1, ry / rx);
```

ここで正円のパスを追加する命令をすれば、勝手に楕円になるわけですね。ではやっていきましょう。
円を描くというより弧を描く関数ですね。このように使います。

```javascript
ctx.arc(中心のX座標, 中心のY座標, 半径, 開始する角度, 終了する角度, 反時計回りか時計回りか)
```

開始する角度を0、終了する角度を $$2\pi$$ (円周率はJavaScriptで`Math.PI`)とすれば円になりますね。
回る方向は円なので関係ないので、とりあえず`false`としておきましょう。

ここで座標軸を拡大縮小したことを思い出してください。
中心のY座標を`cy`にしてしまうと、ずれてしまうので、 $$\frac{ry}{rx}$$ の逆数である $$\frac{rx}{ry}$$ を掛けてあげる必要があります。

これらを踏まえて、円のパスを追加するコードはこのようになります。

```javascript
ctx.arc(cx, cy * rx / ry, rx, 0, 2 * Math.PI, false);
```

これで終わりにしてしまうと、このあとほかの図形を描くときに、この倍率が適用されてしまうので、戻してあげなければいけません。
簡単なやり方は、`ctx.scale`に今の倍率の逆数を入れてあげれば1に戻りますね。

<div class="advance">
<p>これを読んで挫折されてしまうと困るのでここは発展にしておきます:
しかし小数点以下の計算なので誤差が出る可能性があるので、本当に1に戻す方法を紹介します。</p>
<p>
内部ではパスに対して行列計算（アフィン変換）を施して座標を入れ替えています。
これを「座標を変換しない」設定にするとでリセットすることができます。
具体的には $$\begin{pmatrix}1&0&0\\0&1&0\\0&0&1\end{pmatrix}$$ にしてあげます。
</p>
<p>
変換行列の指定には<code>ctx.setTransform(a, b, c, d, e, f)</code>を使います。
引数は $$\begin{pmatrix}a&c&e\\b&d&f\\0&0&1\end{pmatrix}$$ に一致するので、
<code>ctx.setTransform(1, 0, 0, 1, 0, 0)</code>とすれば良さそうです。
</p>
</div>

というわけで、関数`ellipse`はこのようになりました。

```javascript
// cx, cy: 中心座標
// rx: X軸方向の半径, ry: Y軸方向の半径
function ellipse(cx, cy, rx, ry)
{
    ctx.scale(1, ry / rx);
    ctx.arc(cx, cy * rx / ry, rx, 0, 2 * Math.PI, false);
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    // または ctx.scale(1, rx / ry);
}
```

<div class="advance">
<p>
発展と愚痴: 難しいゾーンお疲れ様でした。しかしここで皆さんに重要なお知らせがあります。
なんと<code>ctx.ellipse</code>という方法が存在します！！
しかしですね、学校のPCに入ってるInternet Explorer 11、あいつがですね、これに対応してないんですよ！！ふざけんな。
というわけで、IEよりもっとモダンなブラウザを使っている方は<code>ctx.ellipse</code>を使ってみてください。
使い方を調べるのが発展問題ということで。Mozilla Developer Networkとかにあってみて英語に慣れたりするといいと思います。
</p>
</div>
